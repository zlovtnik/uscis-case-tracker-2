# USCIS Case Tracker (Scala, Cats Effect, gRPC)

## Big picture
- Unified Armeria server runs gRPC (HTTP/2), gRPC-Web (HTTP/1.1), and HTTP health endpoints on one port. Entry point is [src/main/scala/uscis/Main.scala](../src/main/scala/uscis/Main.scala) and server wiring is in [src/main/scala/uscis/server/ArmeriaServer.scala](../src/main/scala/uscis/server/ArmeriaServer.scala).
- gRPC API is defined in [src/main/protobuf/service.proto](../src/main/protobuf/service.proto); code is generated by sbt/fs2-grpc into target/scala-2.13/src_managed (regenerate with `sbt compile`).
- Service logic lives in two layers:
  - IO/fs2-grpc implementation: [src/main/scala/uscis/grpc/USCISCaseServiceImpl.scala](../src/main/scala/uscis/grpc/USCISCaseServiceImpl.scala) contains the core effectful/service business logic using Cats Effect IO and fs2 streams.
  - Armeria adapter (Future-based): [src/main/scala/uscis/grpc/USCISCaseServiceGrpcImpl.scala](../src/main/scala/uscis/grpc/USCISCaseServiceGrpcImpl.scala) is a runtime adapter that converts between the Future-based Armeria gRPC runtime API and the IO/fs2 implementation; it handles error/response translation, execution context/threading concerns, and ensures method signatures/behavior remain synchronized between implementations.
- Persistence is abstracted by `PersistenceManager` with two backends:
  - JSON file storage (default fallback) in [src/main/scala/uscis/persistence/PersistenceManager.scala](../src/main/scala/uscis/persistence/PersistenceManager.scala) using ~/.uscis-tracker.
  - Oracle DB storage in [src/main/scala/uscis/persistence/OraclePersistenceManager.scala](../src/main/scala/uscis/persistence/OraclePersistenceManager.scala). Server chooses backend based on config.
- USCIS API integration and rate-limiting live in [src/main/scala/uscis/api/USCISClient.scala](../src/main/scala/uscis/api/USCISClient.scala) and [src/main/scala/uscis/api/USCISApiClient.scala](../src/main/scala/uscis/api/USCISApiClient.scala).

## Key workflows
- Build/compile (also generates protobuf): `sbt compile` or `make compile` (see [Makefile](../Makefile)).
- Run locally: `sbt run` or `make run`.
- Tests: `sbt test` or `make test`.
- Regenerate IDE files: `sbt bloopInstall` or `make bloop`.
- Docker build runs assembly and produces a fat jar (see [Dockerfile](../Dockerfile)).

## Project-specific conventions
- Server always binds a single port and exposes /health, /ready, /live (see [src/main/scala/uscis/server/ArmeriaServer.scala](../src/main/scala/uscis/server/ArmeriaServer.scala)).
- Timestamps are normalized to UTC when converting to protobuf `Timestamp` (see [src/main/scala/uscis/grpc/USCISCaseServiceImpl.scala](../src/main/scala/uscis/grpc/USCISCaseServiceImpl.scala)).
- Receipt numbers are normalized and validated (3 letters + 10 digits). Use `USCISClient.normalizeReceiptNumber` and `USCISClient.validateReceiptNumber` (see [src/main/scala/uscis/api/USCISClient.scala](../src/main/scala/uscis/api/USCISClient.scala)).
- The Armeria adapter is the runtime gRPC entrypoint; if changing request/response mapping, update both IO and Future implementations to keep behavior consistent.
- Enforce consistency between Armeria adapter's IO implementation and Future implementation with a shared test suite that runs the same mapping tests against both implementations, plus property-based or snapshot tests for edge cases and round-trip invariants. Checklist: Update tests when changing mapping logic to keep dual implementations in sync.

## Configuration and integration points
- Configuration is in [src/main/resources/application.conf](../src/main/resources/application.conf) with env overrides (GRPC_HOST, GRPC_PORT, USCIS_*).
- Storage selection via `uscis.storage.type` (json/oracle). Oracle requires ORACLE_JDBC_URL, ORACLE_USER, ORACLE_PASSWORD and optional wallet path.
- USCIS API credentials are optional; without them the client returns sandbox/mock responses containing static example data based on receipt number prefixes (e.g., IOE-prefixed receipts return "Case Was Received" status). Mocks are suitable for local development and basic integration testing but lack real API behaviors: no authentication errors, rate-limiting, truncated fields, synthetic IDs, and no external side-effects. Use real credentials for production deployments, end-to-end testing, or when testing error scenarios. Mock payloads are defined in [src/main/scala/uscis/api/USCISApiClient.scala](../src/main/scala/uscis/api/USCISApiClient.scala).

## Generated code
- Protobuf and fs2-grpc code are generated under target/scala-2.13/src_managed; do not edit these files directly.